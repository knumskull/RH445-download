---
 
- name: load fileserver
  hosts: localhost
  gather_facts: no

  collections:
     - community.sap_launchpad


  ### This playbook downloads all the SAP files required for installing
  ### SAP HANA and S/4 HANA from Maintenance Planner
  vars_prompt:
    - name: "suser_id"
      prompt: "S-User ID"
      private: false
      default: "{{lookup('env', 'SAP_SUPPORT_DOWNLOAD_USERNAME')}}"
    - name: "suser_password"
      prompt: "S-User PW"
      private: true
      default: "{{lookup('env', 'SAP_SUPPORT_DOWNLOAD_PASSWORD')}}"
    - name: "mp_transaction_name"
      prompt: "Enter Maintenance Planner Transaction Name"
      private: false
      default: MP_S4H_2021_FNDN_INTEL

  vars:
    sap_extra_software:
            - 'SAPCAR_1115-70006238.EXE'

  tasks:
    - name: ensure S-USER and PASSWORD are defined
      fail:
            msg: "Please set SAP_SUPPORT_DOWNLOAD_USERNAME and SAP_SUPPORT_DOWNLOAD_PASSWORD"
      when: ( suser_id|trim ==''  )  or  ( suser_password|trim == '' )
      tags:
        - sap_s4_softwaredownload
        - sap_extra_download

    - name: ensure prereqs are installed
      pip:
        name:
              - urllib3
              - beautifulsoup4
              - lxml
              - requests
        state: present
        virtualenv: "{{ venv | default(omit) }}"
      tags:
        - sap_s4_softwaredownload
        - sap_extra_download

    - name: Execute Ansible Module 'maintenance_planner' to download files from MP config
      community.sap_launchpad.maintenance_planner:
        suser_id: "{{ suser_id }}"
        suser_password: "{{ suser_password }}"
        transaction_name: "{{ mp_transaction_name }}"
      register: sap_maintenance_planner_basket_register
      tags:
        - sap_s4_softwaredownload

    - name: Display Download Basket
      debug:
         msg:
           - "{{ sap_maintenance_planner_basket_register.download_basket }}"
      tags:
         - sap_s4_softwaredownload

    - name: Store Download basket
      copy:
        src: "{{ sap_maintenance_planner_basket_register.download_basket | to_nice_json }}"
        dest: files/sap-dl.json
